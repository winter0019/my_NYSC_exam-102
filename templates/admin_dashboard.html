<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NYSC Exam Prep - Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6 font-sans transition">

  <!-- Custom Modal -->
  <div id="custom-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur">
    <div class="bg-white rounded-xl shadow-xl w-11/12 max-w-md p-6 transform transition-all duration-200 scale-95 opacity-0"
         id="custom-modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 id="modal-title" class="text-xl font-bold text-gray-800"></h3>
        <button onclick="hideModal()" class="text-gray-500 hover:text-gray-800">&times;</button>
      </div>
      <p id="modal-message" class="text-gray-700 mb-4"></p>
      <div class="flex justify-end">
        <button onclick="hideModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- Chat Modal -->
  <div id="chat-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur">
    <div class="bg-white rounded-xl shadow-xl w-11/12 max-w-2xl h-[80%] flex flex-col p-6 transform transition-all duration-200 scale-95 opacity-0"
         id="chat-modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">Discussion Room</h3>
        <button id="leave-room-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
      </div>
      <p id="chat-topic-question" class="text-gray-600 italic mb-4"></p>
      <div id="chat-message-list" class="flex-1 overflow-y-auto border border-gray-200 rounded-lg p-3 space-y-3"></div>
      <form id="send-message-form" class="flex gap-2 mt-4">
        <input id="message-input" type="text" placeholder="Type a message..."
               class="flex-1 rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 p-2" />
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
          Send
        </button>
      </form>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Admin Dashboard</h1>
      <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Logout</button>
    </div>

    <p id="status-message" class="mb-4 text-gray-600">Authenticating...</p>

    <!-- Live Stats -->
    <section class="bg-gray-100 p-6 rounded-lg shadow-inner mb-6">
      <h2 class="text-lg font-semibold mb-4">Live Statistics</h2>
      <p class="text-sm text-gray-600 mb-4">Online user data updates every 10 seconds. User IDs are displayed to help with moderation.</p>
      <p class="text-gray-700">Online Users: <span id="online-users" class="font-bold text-lg">...</span></p>
      <ul id="online-users-list" class="mt-2 space-y-1"></ul>
    </section>

    <!-- Create Discussion -->
    <section class="bg-gray-100 p-6 rounded-lg shadow-inner mb-6">
      <h2 class="text-lg font-semibold mb-4">Create Discussion Topic</h2>
      <form id="create-discussion-form" class="space-y-4">
        <div>
          <label for="discussion-question-input" class="block text-sm font-medium text-gray-700">Discussion Question</label>
          <textarea id="discussion-question-input" rows="4" required
                    class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2"></textarea>
        </div>
        <button type="submit" id="post-discussion-btn"
                class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
          Post Discussion
        </button>
      </form>
    </section>

    <!-- Active Topics -->
    <section class="bg-gray-100 p-6 rounded-lg shadow-inner">
      <h2 class="text-lg font-semibold mb-4">Active Discussion Topics</h2>
      <p class="text-sm text-gray-600 mb-4">Click "Join" to enter a discussion room and moderate the chat.</p>
      <ul id="discussion-topics-list" class="space-y-4"></ul>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, Timestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global vars from backend
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // DOM elements
    const logoutBtn = document.getElementById("logout-btn");
    const statusMessageEl = document.getElementById("status-message");
    const onlineUsersEl = document.getElementById("online-users");
    const onlineUsersListEl = document.getElementById("online-users-list");
    const createDiscussionForm = document.getElementById("create-discussion-form");
    const discussionQuestionInput = document.getElementById("discussion-question-input");
    const discussionTopicsListEl = document.getElementById("discussion-topics-list");
    const postDiscussionBtn = document.getElementById("post-discussion-btn");

    // Modals
    const modal = document.getElementById("custom-modal");
    const modalContent = document.getElementById("custom-modal-content");
    const modalTitle = document.getElementById("modal-title");
    const modalMessage = document.getElementById("modal-message");
    function showModal(title, msg) {
      modalTitle.textContent = title;
      modalMessage.textContent = msg;
      modal.classList.remove("hidden");
      modalContent.classList.remove("scale-95", "opacity-0");
      modalContent.classList.add("scale-100", "opacity-100");
    }
    function hideModal() {
      modal.classList.add("hidden");
      modalContent.classList.add("scale-95", "opacity-0");
      modalContent.classList.remove("scale-100", "opacity-100");
    }

    const chatModal = document.getElementById("chat-modal");
    const chatModalContent = document.getElementById("chat-modal-content");
    const chatTopicQuestion = document.getElementById("chat-topic-question");
    const leaveRoomBtn = document.getElementById("leave-room-btn");
    const chatMessageList = document.getElementById("chat-message-list");
    const sendMessageForm = document.getElementById("send-message-form");
    const messageInput = document.getElementById("message-input");
    let currentRoomId = null;
    let unsubscribeMessages = null;
    let unsubscribePresence = null;
    let presenceIntervalId = null;
    function showChatModal(topicId, question) {
      currentRoomId = topicId;
      chatTopicQuestion.textContent = question;
      chatModal.classList.remove("hidden");
      chatModalContent.classList.remove("scale-95", "opacity-0");
      chatModalContent.classList.add("scale-100", "opacity-100");
      startListeningToMessages(topicId);
    }
    function hideChatModal() {
      currentRoomId = null;
      chatModal.classList.add("hidden");
      chatModalContent.classList.add("scale-95", "opacity-0");
      chatModalContent.classList.remove("scale-100", "opacity-100");
      chatMessageList.innerHTML = "";
      if (unsubscribeMessages) { unsubscribeMessages(); unsubscribeMessages = null; }
    }

    // Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const updatePresence = (user, roomId=null) => {
      const ref = doc(db, `artifacts/${appId}/public/data/presence_users/${user.uid}`);
      setDoc(ref, { userId: user.uid, last_active: Timestamp.now(), type: "admin", current_room: roomId }, { merge: true });
    };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        statusMessageEl.textContent = `Welcome, Admin ðŸŽ‰`;
        updatePresence(user, currentRoomId);
        if (presenceIntervalId) clearInterval(presenceIntervalId);
        presenceIntervalId = setInterval(() => updatePresence(user, currentRoomId), 10000);
        startListeningToDiscussions();
        startListeningToOnlineUsers();
      } else {
        statusMessageEl.textContent = "Signing you in...";
        if (presenceIntervalId) clearInterval(presenceIntervalId);
        if (unsubscribePresence) unsubscribePresence();
        if (unsubscribeMessages) unsubscribeMessages();
        try {
          if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
          else await signInAnonymously(auth);
        } catch (err) {
          console.error(err); showModal("Auth Error","Failed to sign in.");
        }
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try { await signOut(auth); showModal("Logged Out","You have been signed out."); }
      catch { showModal("Logout Failed","Could not sign out."); }
    });

    createDiscussionForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      postDiscussionBtn.disabled = true; postDiscussionBtn.textContent = "Posting...";
      const q = discussionQuestionInput.value.trim();
      if (!q) { showModal("Invalid Input","Question cannot be empty."); postDiscussionBtn.disabled=false; postDiscussionBtn.textContent="Post Discussion"; return; }
      try {
        const ref = collection(db, `artifacts/${appId}/public/data/discussion_topics`);
        await addDoc(ref, { question: q, posted_at: Timestamp.now() });
        showModal("Success","Discussion posted!");
        discussionQuestionInput.value="";
      } catch(err) { showModal("Error",err.message); }
      postDiscussionBtn.disabled=false; postDiscussionBtn.textContent="Post Discussion";
    });

    leaveRoomBtn.addEventListener("click", () => {
      if (auth.currentUser) updatePresence(auth.currentUser,null);
      hideChatModal();
    });

    sendMessageForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = messageInput.value.trim();
      if (msg && currentRoomId) {
        const ref = collection(db, `artifacts/${appId}/public/data/discussion_topics/${currentRoomId}/messages`);
        await addDoc(ref, { text: msg, senderId: auth.currentUser.uid, senderType: "admin", timestamp: Timestamp.now() });
        messageInput.value="";
        chatMessageList.scrollTop = chatMessageList.scrollHeight;
      }
    });

    const startListeningToOnlineUsers = () => {
      if (unsubscribePresence) unsubscribePresence();
      const ref = collection(db, `artifacts/${appId}/public/data/presence_users`);
      unsubscribePresence = onSnapshot(query(ref), (snap) => {
        const cutoff = Timestamp.now().seconds - 60;
        const online = [];
        const counts = {};
        snap.forEach(d => {
          const data = d.data();
          if (data.last_active?.seconds > cutoff) {
            const id = data.userId===auth.currentUser.uid ? "You (Admin)" : `User: ${data.userId}`;
            online.push(id);
            if (data.current_room) counts[data.current_room] = (counts[data.current_room]||0)+1;
          }
        });
        onlineUsersEl.textContent = online.length;
        onlineUsersListEl.innerHTML="";
        online.forEach(id => {
          const li = document.createElement("li");
          li.className="flex items-center gap-2 text-gray-700";
          li.innerHTML=`<span class="text-green-500">â€¢</span>${id}`;
          onlineUsersListEl.appendChild(li);
        });
        updateDiscussionCounts(counts);
      });
    };

    const updateDiscussionCounts = (counts) => {
      discussionTopicsListEl.querySelectorAll(".topic-item").forEach(el => {
        const count = counts[el.dataset.id] || 0;
        el.querySelector(".user-count").textContent = `${count} User${count!==1?"s":""}`;
      });
    };

    const startListeningToDiscussions = () => {
      const ref = collection(db, `artifacts/${appId}/public/data/discussion_topics`);
      onSnapshot(ref, (snap) => {
        discussionTopicsListEl.innerHTML="";
        snap.forEach(d => {
          const data=d.data(), id=d.id;
          const li=document.createElement("li");
          li.dataset.id=id;
          li.className="bg-white p-4 rounded-lg shadow border border-gray-200 flex flex-col gap-2 topic-item";
          li.innerHTML=`
            <p class="font-semibold text-gray-800">${data.question}</p>
            <div class="flex items-center justify-between text-sm text-gray-500">
              <span class="user-count">0 Users</span>
              <button class="join-btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Join</button>
            </div>`;
          li.querySelector(".join-btn").addEventListener("click", () => {
            updatePresence(auth.currentUser,id);
            showChatModal(id,data.question);
          });
          discussionTopicsListEl.appendChild(li);
        });
      });
    };

    const startListeningToMessages = (topicId) => {
      if (unsubscribeMessages) unsubscribeMessages();
      const ref = collection(db, `artifacts/${appId}/public/data/discussion_topics/${topicId}/messages`);
      unsubscribeMessages=onSnapshot(query(ref),(snap)=>{
        chatMessageList.innerHTML="";
        snap.forEach(d=>{
          const data=d.data();
          const mine=data.senderId===auth.currentUser.uid;
          const div=document.createElement("div");
          div.className=`max-w-[80%] p-2 rounded-lg ${mine?"bg-blue-600 text-white self-end":"bg-gray-200 text-gray-800 self-start"}`;
          div.innerHTML=`<p class="font-bold text-xs mb-1">${mine?"You":"User: "+data.senderId}</p><p>${data.text}</p>`;
          chatMessageList.appendChild(div);
        });
        chatMessageList.scrollTop=chatMessageList.scrollHeight;
      });
    };
  </script>
</body>
</html>
